<!-- Cooking Group Lottery System V8.3 -->
<!-- Updates: Added Pillow Image for Winner Prize & Khmer Text -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UC Home MasterChef V8.3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Product Sans', 'sans-serif'],
                        header: ['Product Sans', 'Inter', 'sans-serif'],
                        mono: ['Fira Code', 'monospace'],
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'flip': 'flipIn 0.6s ease-out forwards',
                        'pop': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'spin-fast': 'spin 0.2s linear infinite',
                        'fade-in-up': 'fadeInUp 0.5s ease-out forwards',
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'rise': 'rise 4s ease-in infinite',
                    },
                    keyframes: {
                        flipIn: {
                            '0%': { transform: 'rotateY(0deg)' },
                            '100%': { transform: 'rotateY(360deg)' },
                        },
                        popIn: {
                            '0%': { transform: 'scale(0.8)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fadeInUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        rise: {
                            '0%': { bottom: '-50px', opacity: '0' },
                            '50%': { opacity: '1' },
                            '100%': { bottom: '100vh', opacity: '0' },
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Fira+Code:wght@500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        @font-face { font-family: 'Product Sans'; src: local('Product Sans'), url('https://fonts.gstatic.com/s/productsans/v9/HYvgU2fE2nRJvZ5JFAumwegdm0LZdjqr5-oayXSOefg.woff2'); font-weight: 400; }
        @font-face { font-family: 'Product Sans'; src: local('Product Sans Bold'), url('https://fonts.gstatic.com/s/productsans/v9/HYvgU2fE2nRJvZ5JFAumwegdm0LZdjqr5-oayXSOefg.woff2'); font-weight: 700; }

        body {
            transition: background-color 0.5s ease;
        }
        body.light-mode {
            background-color: #fff7ed;
            background-image: radial-gradient(#fdba74 1px, transparent 1px);
            background-size: 20px 20px;
        }
        body.dark-mode {
            background-color: #111827;
            background-image: radial-gradient(#374151 1px, transparent 1px);
            background-size: 20px 20px;
            color: #f3f4f6;
        }
        
        .card-initial { background: white; border: 2px dashed #cbd5e1; }
        .dark-mode .card-initial { background: #1f2937; border: 2px dashed #4b5563; color: white; }
        
        .card-oven { background: linear-gradient(135deg, #fff1f2 0%, #ffe4e6 100%); border: 2px solid #f43f5e; color: #be123c; }
        .dark-mode .card-oven { background: linear-gradient(135deg, #4c0519 0%, #881337 100%); border: 2px solid #f43f5e; color: #fda4af; }
        
        .card-hob { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border: 2px solid #3b82f6; color: #1d4ed8; }
        .dark-mode .card-hob { background: linear-gradient(135deg, #172554 0%, #1e3a8a 100%); border: 2px solid #3b82f6; color: #bfdbfe; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .dark-mode .glass-panel {
            background: rgba(31, 41, 55, 0.9);
            border: 1px solid rgba(75, 85, 99, 0.5);
            color: white;
        }
        
        .perspective-1000 { perspective: 1000px; }

        /* Emoji Rain Animation */
        .emoji-rain {
            position: fixed;
            top: -50px;
            font-size: 24px;
            z-index: 9999;
            animation: fall linear forwards;
            pointer-events: none;
        }
        @keyframes fall {
            to { transform: translateY(110vh) rotate(360deg); }
        }

        /* Bubbles */
        .bubble {
            position: fixed;
            bottom: -50px;
            background: rgba(173, 216, 230, 0.5);
            border-radius: 50%;
            z-index: 9999;
            pointer-events: none;
            animation: rise linear forwards;
            border: 1px solid rgba(255, 255, 255, 0.8);
        }
        
        /* Flash */
        #flash-overlay {
            pointer-events: none;
            transition: opacity 0.1s ease-out;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center font-sans text-slate-800 pb-48 light-mode" id="main-body">

    <!-- Flash Overlay -->
    <div id="flash-overlay" class="fixed inset-0 bg-white z-[100] opacity-0"></div>

    <!-- Header & Controls -->
    <header class="w-full max-w-5xl mb-6 mt-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-center md:text-left">
            <h1 class="font-header text-3xl md:text-4xl drop-shadow-sm bg-white dark:bg-gray-800 px-6 py-2 rounded-full border-4 border-orange-200 dark:border-gray-600 inline-block tracking-tight text-slate-800 dark:text-white">
                UC Home MasterChef
            </h1>
            <p class="text-slate-500 dark:text-slate-400 font-bold mt-2 text-sm flex items-center gap-2 justify-center md:justify-start">
                <span class="bg-green-100 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold">V8.3</span>
                <button onclick="window.toggleVoice()" id="voice-toggle" class="cursor-pointer hover:underline">üîä Voice ON</button>
            </p>
        </div>
        
        <div class="flex gap-2">
            <button onclick="window.toggleTheme()" class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 flex items-center justify-center transition hover:scale-110">
                <i class="fa-solid fa-moon dark:hidden"></i>
                <i class="fa-solid fa-sun hidden dark:block text-yellow-400"></i>
            </button>
            <button onclick="window.showResetModal()" class="px-4 py-2 bg-slate-200 dark:bg-slate-700 rounded-xl text-sm font-bold hover:bg-red-100 dark:hover:bg-red-900 dark:text-white transition">
                Reset All
            </button>
        </div>
    </header>

    <!-- TOP BAR: First to Cook & Timer -->
    <div class="w-full max-w-5xl mb-8 grid grid-cols-1 md:grid-cols-2 gap-4">
        
        <!-- First to Cook Spin -->
        <div class="glass-panel px-4 py-3 rounded-2xl flex items-center justify-between border-l-4 border-blue-500">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center text-xl">‚è±Ô∏è</div>
                <div>
                    <p class="text-[10px] uppercase font-bold opacity-60 tracking-wider">First to Cook</p>
                    <div id="order-display" class="font-bold text-lg leading-tight text-blue-600 dark:text-blue-400">???</div>
                </div>
            </div>
            <button onclick="window.spinOrder()" class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center hover:bg-blue-600 transition shadow-lg active:scale-90">
                <i class="fa-solid fa-play"></i>
            </button>
        </div>

        <!-- Timer -->
        <div class="glass-panel px-4 py-3 rounded-2xl flex items-center justify-between border-l-4 border-orange-500">
            <div class="text-right flex-1 mr-4">
                <p class="text-[10px] uppercase font-bold opacity-60 tracking-wider">Cooking Timer</p>
                <div id="timer-display" class="font-mono text-2xl font-bold text-orange-600 dark:text-orange-400">00:00:00</div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.toggleTimer()" id="timer-btn" class="w-10 h-10 rounded-full bg-green-500 text-white hover:bg-green-600 flex items-center justify-center shadow-lg transition transform active:scale-95">
                    <i class="fa-solid fa-play"></i>
                </button>
                <button onclick="window.setTimerModal()" class="w-10 h-10 rounded-full bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 flex items-center justify-center transition">
                    <i class="fa-solid fa-gear"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- MAIN GRID (Lottery) -->
    <main id="groups-grid" class="w-full max-w-5xl grid grid-cols-1 md:grid-cols-2 gap-6 p-2 perspective-1000 mb-8">
        <!-- Cards injected via JS -->
    </main>

    <!-- MIDDLE BAR: Chaos & Scoreboard -->
    <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-3 gap-6 mb-24">
        
        <!-- Chaos Card -->
        <div class="lg:col-span-1 bg-gradient-to-br from-pink-500 to-rose-600 rounded-3xl p-6 text-white shadow-lg relative overflow-hidden flex flex-col items-center justify-center text-center">
            <div class="absolute top-0 right-0 p-4 opacity-20 text-6xl"><i class="fa-solid fa-dice"></i></div>
            <h2 class="font-header text-2xl mb-2">Kitchen Chaos</h2>
            <div id="chaos-display" class="mb-4 min-h-[60px] flex items-center justify-center">
                <p class="text-white/80 italic text-sm">Draw a card for a random event!</p>
            </div>
            <button onclick="window.drawChaos()" class="px-6 py-2 bg-white text-rose-600 font-bold rounded-full shadow-md hover:bg-rose-50 transition active:scale-95 text-sm">
                <i class="fa-solid fa-shuffle"></i> Draw Card
            </button>
        </div>

        <!-- Scoreboard -->
        <div class="lg:col-span-2 glass-panel rounded-3xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="font-header text-xl">üïµÔ∏è Secret Scoreboard</h2>
                <span class="text-xs bg-slate-200 dark:bg-slate-700 px-2 py-1 rounded">4 Judges</span>
            </div>
            <div id="scoreboard-list" class="space-y-3">
                <!-- Scores injected here -->
            </div>
            <button onclick="window.revealResults()" class="mt-6 w-full py-3 bg-slate-800 dark:bg-slate-700 hover:bg-slate-900 text-white font-bold rounded-xl shadow-lg transition flex items-center justify-center gap-2">
                <i class="fa-solid fa-trophy text-yellow-400"></i> Reveal Winners
            </button>
        </div>
    </div>

    <!-- BOTTOM BAR: HAPPY FUNCTIONS -->
    <div class="fixed bottom-0 left-0 right-0 bg-white dark:bg-gray-900 border-t border-slate-200 dark:border-gray-700 p-3 z-40 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)]">
        <div class="max-w-6xl mx-auto flex flex-col gap-2">
            <div class="flex justify-between items-center">
                <span class="text-xs font-bold text-slate-400 uppercase">Happy Bar (10 Tools):</span>
                <button onclick="document.getElementById('log-panel').classList.toggle('hidden')" class="text-xs text-orange-500 hover:underline">Log</button>
            </div>
            
            <div class="flex gap-3 overflow-x-auto pb-2 w-full no-scrollbar">
                <!-- 1. Party -->
                <button onclick="window.triggerParty()" class="px-4 py-2 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-champagne-glasses"></i> Party
                </button>
                <!-- 2. Hype -->
                <button onclick="window.triggerHype()" class="px-4 py-2 bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-fire"></i> Hype
                </button>
                <!-- 3. Rain -->
                <button onclick="window.toggleRain()" id="btn-rain" class="px-4 py-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-cloud-rain"></i> Rain
                </button>
                <!-- 4. Cheers -->
                <button onclick="window.generateCheers()" class="px-4 py-2 bg-green-100 hover:bg-green-200 text-green-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-bullhorn"></i> Cheers
                </button>
                <!-- 5. Colors -->
                <button onclick="window.assignLuckyColors()" class="px-4 py-2 bg-pink-100 hover:bg-pink-200 text-pink-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-palette"></i> Colors
                </button>
                
                <!-- NEW FUNCTIONS -->
                <!-- 6. Fate -->
                <button onclick="window.predictFate()" class="px-4 py-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-crystal-ball"></i> Fate
                </button>
                <!-- 7. Dance -->
                <button onclick="window.triggerDance()" class="px-4 py-2 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-music"></i> Dance
                </button>
                <!-- 8. Flash -->
                <button onclick="window.triggerFlash()" class="px-4 py-2 bg-slate-100 hover:bg-slate-300 text-slate-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-camera-flash"></i> Flash
                </button>
                <!-- 9. Bubbles -->
                <button onclick="window.spawnBubbles()" class="px-4 py-2 bg-cyan-100 hover:bg-cyan-200 text-cyan-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-soap"></i> Bubbles
                </button>
                <!-- 10. Quake -->
                <button onclick="window.triggerQuake()" class="px-4 py-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-xl font-bold text-sm transition flex items-center gap-2 min-w-max">
                    <i class="fa-solid fa-house-crack"></i> Quake
                </button>
            </div>
        </div>
    </div>

    <!-- LOG PANEL -->
    <div id="log-panel" class="fixed bottom-24 right-4 w-64 bg-black/80 text-green-400 font-mono text-xs p-4 rounded-xl shadow-2xl z-50 hidden max-h-40 overflow-y-auto">
        <h4 class="font-bold text-white mb-2 border-b border-gray-600 pb-1">Live Action Log</h4>
        <div id="log-content" class="space-y-1"></div>
    </div>

    <!-- HYPE TOAST -->
    <div id="hype-toast" class="fixed top-20 left-1/2 transform -translate-x-1/2 bg-white dark:bg-gray-800 text-slate-800 dark:text-white px-8 py-4 rounded-full shadow-2xl z-[90] hidden animate-bounce-slow text-xl font-bold border-2 border-orange-400 flex items-center gap-3">
        <span class="text-3xl">üî•</span>
        <span id="hype-msg">Let him cook!</span>
    </div>

    <!-- MODALS -->
    <!-- 1. Timer Setup -->
    <div id="timer-modal" class="fixed inset-0 bg-black/60 z-[80] hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-2xl max-w-sm w-full text-center">
            <h3 class="font-header text-xl mb-4 dark:text-white">Set Timer</h3>
            <div class="grid grid-cols-1 gap-3 mb-6">
                <button onclick="window.setTimer(20)" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-orange-100 rounded-xl font-bold transition flex items-center justify-center gap-2"><i class="fa-regular fa-clock"></i> 20 Minutes</button>
                <button onclick="window.setTimer(25)" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-orange-100 rounded-xl font-bold transition flex items-center justify-center gap-2"><i class="fa-regular fa-clock"></i> 25 Minutes</button>
                <button onclick="window.setTimer(30)" class="w-full px-4 py-3 bg-slate-100 dark:bg-slate-700 hover:bg-orange-100 rounded-xl font-bold transition flex items-center justify-center gap-2"><i class="fa-regular fa-clock"></i> 30 Minutes</button>
                <button onclick="window.setRandomTimer()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-500 to-indigo-600 text-white hover:opacity-90 rounded-xl font-bold transition flex items-center justify-center gap-2 shadow-md">
                    <i class="fa-solid fa-shuffle"></i> Random (20/25/30)
                </button>
            </div>
            <button onclick="document.getElementById('timer-modal').classList.add('hidden')" class="w-full py-2 bg-slate-800 text-white rounded-xl font-bold">Close</button>
        </div>
    </div>

    <!-- 2. Judge Input -->
    <div id="judge-modal" class="fixed inset-0 bg-black/80 z-[60] hidden flex items-center justify-center backdrop-blur-md p-4">
        <div class="bg-white dark:bg-gray-800 rounded-3xl p-8 shadow-2xl max-w-md w-full text-center relative">
            <button onclick="window.closeJudgeModal()" class="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark text-xl"></i></button>
            <h3 class="font-header text-lg text-slate-500 mb-1">Scoring for</h3>
            <h2 id="judge-team-name" class="font-header text-3xl text-slate-800 dark:text-white mb-6">Team Name</h2>
            <div class="grid grid-cols-2 gap-4 mb-6">
                <div><label class="block text-xs font-bold text-slate-400 mb-1">JUDGE 1</label><input type="number" id="score-j1" class="w-full text-center text-xl font-bold p-3 rounded-xl border-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-400 mb-1">JUDGE 2</label><input type="number" id="score-j2" class="w-full text-center text-xl font-bold p-3 rounded-xl border-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-400 mb-1">JUDGE 3</label><input type="number" id="score-j3" class="w-full text-center text-xl font-bold p-3 rounded-xl border-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
                <div><label class="block text-xs font-bold text-slate-400 mb-1">JUDGE 4</label><input type="number" id="score-j4" class="w-full text-center text-xl font-bold p-3 rounded-xl border-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div>
            </div>
            <button onclick="window.saveScore()" class="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md">Save Scores</button>
        </div>
    </div>

    <!-- 3. Results -->
    <div id="results-modal" class="fixed inset-0 bg-black/90 z-[70] hidden flex flex-col items-center justify-center backdrop-blur-lg p-4 overflow-y-auto">
        <div class="w-full max-w-2xl text-center mb-8 pt-10">
            <h2 class="font-header text-4xl md:text-5xl text-white mb-2">Final Results</h2>
            <p class="text-slate-300">Calculating...</p>
        </div>
        <div id="results-list" class="w-full max-w-xl space-y-4 mb-8"></div>
        <div class="flex gap-4">
            <button onclick="window.shareResults()" class="py-3 px-8 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-bold shadow-lg flex items-center gap-2"><i class="fa-brands fa-telegram"></i> Copy</button>
            <button onclick="window.closeResultsModal()" class="py-3 px-8 bg-white/10 hover:bg-white/20 text-white rounded-full font-bold border border-white/20">Close</button>
        </div>
    </div>

    <!-- 4. Reset Confirmation -->
    <div id="reset-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 shadow-2xl max-w-sm text-center">
            <div class="text-5xl mb-4">üîÑ</div>
            <h3 class="font-header text-xl dark:text-white mb-2">Start Over?</h3>
            <div class="flex gap-3 mt-4">
                <button onclick="window.hideResetModal()" class="flex-1 py-2 bg-slate-100 dark:bg-slate-700 rounded-xl font-bold">No</button>
                <button onclick="window.confirmResetGame()" class="flex-1 py-2 bg-orange-500 text-white rounded-xl font-bold">Yes</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        const groupsData = [
            { id: 1, name: 'Team Alpha', members: ['Ken', 'Meng Ey'], scores: [0,0,0,0], total: 0, scored: false, cheer: '', color: '' },
            { id: 2, name: 'Team Beta', members: ['Nin', 'Vichet'], scores: [0,0,0,0], total: 0, scored: false, cheer: '', color: '' },
            { id: 3, name: 'Team Charlie', members: ['Sarin', 'Theavy', 'Chantrea'], scores: [0,0,0,0], total: 0, scored: false, cheer: '', color: '' },
            { id: 4, name: 'Team Delta', members: ['Kimteang', 'Kimeay', 'Ehong'], scores: [0,0,0,0], total: 0, scored: false, cheer: '', color: '' }
        ];
        // 18 Chaos Cards
        const chaosCards = [
            { icon: 'ü§è', title: 'One Handed!', desc: 'Chefs must cook with one hand behind their back for 5 mins.' },
            { icon: 'ü§ê', title: 'Silent Kitchen', desc: 'No talking allowed for 10 minutes!' },
            { icon: 'ü•Ñ', title: 'Spoon Only', desc: 'Chefs can only use spoons to prep/cook for 5 mins.' },
            { icon: 'üôà', title: 'Blind Taste', desc: 'One member must taste food blindfolded.' },
            { icon: 'üîÑ', title: 'Swap Stations', desc: 'Teams must rotate stations clockwise once!' },
            { icon: 'üì∏', title: 'Selfie Time', desc: 'Take a group selfie with the food immediately.' },
            { icon: 'üíÉ', title: 'Dance Break', desc: 'Stop cooking and dance for 30 seconds!' },
            { icon: 'üßÇ', title: 'Salty Sabotage', desc: 'Judge adds a pinch of salt to your dish!' },
            { icon: 'ü•∂', title: 'Freeze!', desc: 'Everyone stop moving for 30 seconds!' },
            { icon: 'üßº', title: 'Clean Up', desc: 'Stop cooking and clean your station for 2 minutes.' },
            { icon: 'üé≠', title: 'Mime Time', desc: 'No talking, only gestures/acting for 5 minutes.' },
            { icon: 'ü•¢', title: 'Chopsticks Only', desc: 'Use only chopsticks for prep/cooking for 3 mins.' },
            { icon: 'üì£', title: 'Sports Caster', desc: 'Narrate your cooking like a football match for 2 mins.' },
            { icon: 'ü´Ç', title: 'Group Hug', desc: 'Team hug for 10 seconds before continuing!' },
            { icon: 'üëÄ', title: 'Backseat Chef', desc: 'One member directs verbally only (no touching) for 3 mins.' },
            { icon: 'üé§', title: 'Sing Along', desc: 'Sing a song loudly while cooking for 1 minute.' },
            { icon: 'üßä', title: 'Ice Challenge', desc: 'Hold an ice cube in one hand until it melts.' },
            { icon: 'üçã', title: 'Sour Twist', desc: 'You must add a squeeze of lemon/lime to the dish.' }
        ];
        
        let fateBucket = [];
        let isSpinning = {};
        let currentJudgingIndex = null;
        let voiceEnabled = true;
        let timerInterval, timeRemaining = 0, isTimerRunning = false;
        let isRainActive = false;

        // --- INIT ---
        window.onload = function() {
            initGame();
            logAction("System initialized.");
        };

        window.initGame = function() {
            fateBucket = ['Oven', 'Oven', 'Hob', 'Hob'];
            fateBucket.sort(() => Math.random() - 0.5);
            document.getElementById('groups-grid').innerHTML = '';
            groupsData.forEach((group, index) => renderCard(index, group));
            renderScoreboard();
        }

        // --- CORE FEATURES ---
        window.toggleTheme = function() {
            document.body.classList.toggle('dark-mode');
            document.body.classList.toggle('light-mode');
            logAction("Theme toggled.");
        }

        window.logAction = function(msg) {
            const box = document.getElementById('log-content');
            const time = new Date().toLocaleTimeString();
            box.innerHTML = `<div class="border-b border-gray-800 pb-1 mb-1">[${time}] ${msg}</div>` + box.innerHTML;
        }

        window.speak = function(text) {
            if(!voiceEnabled || !window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 1.1;
            window.speechSynthesis.speak(utterance);
        }
        window.toggleVoice = function() {
            voiceEnabled = !voiceEnabled;
            document.getElementById('voice-toggle').textContent = voiceEnabled ? 'üîä Voice ON' : 'üîá Voice OFF';
        }

        // --- HAPPY FUNCTIONS ---
        // 1. Party
        window.triggerParty = function() {
            window.safeConfetti({ particleCount: 200, spread: 180, origin: { y: 0.6 }, colors: ['#f472b6', '#22d3ee', '#fbbf24'] });
            speak("Let's party!");
            logAction("Party triggered!");
        }
        // 2. Hype
        window.triggerHype = function() {
            const messages = ["Let him cook!", "Chef's Kiss!", "It's RAW!", "Flavor Explosion!", "Yes Chef!", "Sizzle Sizzle!"];
            const msg = messages[Math.floor(Math.random() * messages.length)];
            const toast = document.getElementById('hype-toast');
            document.getElementById('hype-msg').textContent = msg;
            toast.classList.remove('hidden');
            speak(msg);
            setTimeout(() => toast.classList.add('hidden'), 2000);
            logAction(`Hype: ${msg}`);
        }
        // 3. Rain
        window.toggleRain = function() {
            isRainActive = !isRainActive;
            const btn = document.getElementById('btn-rain');
            if(isRainActive) {
                btn.classList.replace('bg-blue-100', 'bg-blue-300');
                startRain();
                logAction("Rain started.");
            } else {
                btn.classList.replace('bg-blue-300', 'bg-blue-100');
                stopRain();
                logAction("Rain stopped.");
            }
        }
        let rainInterval;
        function startRain() {
            const emojis = ['üçï','üçî','üçü','üç∫','ü•§','ü•¶','üçó','üçú'];
            rainInterval = setInterval(() => {
                const el = document.createElement('div');
                el.innerText = emojis[Math.floor(Math.random() * emojis.length)];
                el.className = 'emoji-rain';
                el.style.left = Math.random() * 100 + 'vw';
                el.style.animationDuration = Math.random() * 2 + 3 + 's';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 5000);
            }, 300);
        }
        function stopRain() { clearInterval(rainInterval); }
        // 4. Cheers
        window.generateCheers = function() {
            const cheers = ["Sizzle & Serve!", "Taste the Victory!", "Born to Cook!", "Grill Masters!", "Spice Kings!", "Delicious Duo!", "Cooking Chaos!"];
            groupsData.forEach((g, i) => {
                g.cheer = cheers[Math.floor(Math.random() * cheers.length)];
                renderCard(i, g); 
            });
            speak("Cheers generated!");
            logAction("Cheers assigned.");
        }
        // 5. Colors
        window.assignLuckyColors = function() {
            const colors = ['#fecaca', '#bbf7d0', '#bfdbfe', '#fde68a', '#ddd6fe', '#fed7aa']; 
            groupsData.forEach((g, i) => {
                g.color = colors[Math.floor(Math.random() * colors.length)];
                document.getElementById(`card-${i}`).style.backgroundColor = g.color;
            });
            speak("Lucky colors assigned!");
            logAction("Colors assigned.");
        }
        // 6. Fate
        window.predictFate = function() {
            const fates = ["Delicious üòã", "Burnt üòñ", "Raw ü¶ñ", "Salty üßÇ", "Perfect üëå", "Gordon Ramsey Hates It ü§¨"];
            const fate = fates[Math.floor(Math.random() * fates.length)];
            const toast = document.getElementById('hype-toast');
            document.getElementById('hype-msg').textContent = "Prediction: " + fate;
            toast.classList.remove('hidden');
            speak("Prediction: " + fate);
            setTimeout(() => toast.classList.add('hidden'), 2500);
            logAction(`Fate: ${fate}`);
        }
        // 7. Dance
        window.triggerDance = function() {
            const cards = document.querySelectorAll('.card-initial, .card-oven, .card-hob');
            cards.forEach(card => card.classList.add('animate-wiggle'));
            speak("Everybody dance now!");
            logAction("Dance triggered.");
            setTimeout(() => {
                cards.forEach(card => card.classList.remove('animate-wiggle'));
            }, 3000);
        }
        // 8. Flash
        window.triggerFlash = function() {
            const overlay = document.getElementById('flash-overlay');
            overlay.style.opacity = '1';
            setTimeout(() => overlay.style.opacity = '0', 100);
            speak("Cheese!");
            logAction("Flash triggered.");
        }
        // 9. Bubbles
        window.spawnBubbles = function() {
            for(let i=0; i<20; i++) {
                setTimeout(() => {
                    const el = document.createElement('div');
                    el.className = 'bubble';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.width = el.style.height = (Math.random() * 30 + 10) + 'px';
                    el.style.animationDuration = (Math.random() * 3 + 2) + 's';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 5000);
                }, i * 200);
            }
            speak("Bubbles!");
            logAction("Bubbles spawned.");
        }
        // 10. Quake
        window.triggerQuake = function() {
            document.body.classList.add('animate-shake');
            speak("Earthquake!");
            logAction("Quake triggered.");
            setTimeout(() => document.body.classList.remove('animate-shake'), 500);
        }

        // --- TIMER ---
        window.setTimerModal = () => document.getElementById('timer-modal').classList.remove('hidden');
        window.setTimer = (min) => {
            timeRemaining = min * 60;
            updateTimerDisplay();
            document.getElementById('timer-modal').classList.add('hidden');
            speak(min + " minutes set.");
            logAction(`Timer set to ${min} mins.`);
        };
        window.setRandomTimer = () => {
            // Randomly pick one of the 3 specified times
            const options = [20, 25, 30];
            const min = options[Math.floor(Math.random() * options.length)];
            
            // Visual feedback
            const btn = document.querySelector('#timer-modal button .fa-shuffle').parentNode;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spin fa-spinner"></i> Picking...';
            
            setTimeout(() => {
                setTimer(min);
                btn.innerHTML = originalText;
                speak("Randomly selected: " + min + " minutes!");
            }, 600);
        };
        window.toggleTimer = () => {
            if(isTimerRunning) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                document.getElementById('timer-btn').innerHTML = '<i class="fa-solid fa-play"></i>';
            } else {
                if(timeRemaining <= 0) return alert("Set time first!");
                isTimerRunning = true;
                document.getElementById('timer-btn').innerHTML = '<i class="fa-solid fa-pause"></i>';
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    if(timeRemaining <= 0) {
                        clearInterval(timerInterval);
                        isTimerRunning = false;
                        speak("Time is up!");
                        alert("Time's Up!");
                    }
                }, 1000);
            }
        };
        function updateTimerDisplay() {
            const h = Math.floor(timeRemaining / 3600), m = Math.floor((timeRemaining % 3600) / 60), s = timeRemaining % 60;
            document.getElementById('timer-display').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
        }

        // --- CHAOS ---
        window.drawChaos = function() {
            const display = document.getElementById('chaos-display');
            display.innerHTML = '<div class="text-4xl animate-spin">üé≤</div>';
            setTimeout(() => {
                const card = chaosCards[Math.floor(Math.random() * chaosCards.length)];
                display.innerHTML = `<div class="animate-pop"><div class="text-4xl mb-1">${card.icon}</div><h3 class="font-bold text-lg text-purple-700">${card.title}</h3><p class="text-sm text-slate-600">${card.desc}</p></div>`;
                speak("Chaos! " + card.title);
                logAction(`Chaos Card Drawn: ${card.title}`);
            }, 800);
        }

        // --- ORDER SPIN ---
        window.spinOrder = function() {
            const display = document.getElementById('order-display');
            display.innerHTML = '<div class="text-xl animate-spin">‚è±Ô∏è</div>';
            
            let count = 0;
            const interval = setInterval(() => {
                const randomTeam = groupsData[Math.floor(Math.random() * groupsData.length)];
                display.innerHTML = `<h3 class="font-bold text-xl text-blue-300 opacity-80">${randomTeam.name}</h3>`;
                count++;
                if(count > 15) {
                    clearInterval(interval);
                    const winner = groupsData[Math.floor(Math.random() * groupsData.length)];
                    display.innerHTML = `<div class="animate-pop"><h3 class="font-header text-xl text-blue-700 dark:text-blue-300">${winner.name}</h3></div>`;
                    speak(winner.name + " cooks first!");
                    logAction(`Order: ${winner.name} starts.`);
                    const rect = display.getBoundingClientRect();
                    window.safeConfetti({ particleCount: 30, spread: 30, origin: { x: (rect.left + rect.width/2)/window.innerWidth, y: (rect.top + rect.height/2)/window.innerHeight }});
                }
            }, 100);
        }

        // --- LOTTERY ---
        function renderCard(index, group) {
            const grid = document.getElementById('groups-grid');
            let card = document.getElementById(`card-${index}`);
            const content = `
                <div class="z-10 w-full pointer-events-none">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="font-header text-2xl dark:text-white">${group.name}</h2>
                        <span class="bg-slate-100 dark:bg-slate-600 text-slate-500 dark:text-white text-base px-3 py-1 rounded-full font-bold">üßç ${group.members.length}</span>
                    </div>
                    <div class="flex flex-wrap gap-2 mb-2 pointer-events-auto">
                        ${group.members.map(m => `<span class="bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 px-3 py-1.5 rounded-lg text-base font-bold dark:text-slate-300">${m}</span>`).join('')}
                    </div>
                    ${group.cheer ? `<p class="text-xs text-orange-500 font-bold italic mt-2 animate-bounce-slow">"${group.cheer}"</p>` : ''}
                </div>
                <div id="action-area-${index}" class="z-20 mt-auto w-full relative">
                    <button onclick="window.revealFate(${index})" class="w-full py-4 bg-slate-800 hover:bg-slate-900 text-white font-bold rounded-xl shadow-lg transition active:scale-95 flex items-center justify-center gap-2 relative z-30">
                        <span>‚ùì Reveal Fate</span>
                    </button>
                </div>
            `;
            if(card) { 
                card.className = 'card-initial rounded-3xl p-6 shadow-md relative overflow-hidden min-h-[220px] flex flex-col justify-between'; 
                card.innerHTML = content; 
                if(group.color) card.style.backgroundColor = group.color;
            }
            else { 
                card = document.createElement('div'); 
                card.id = `card-${index}`; 
                card.className = 'card-initial rounded-3xl p-6 shadow-md relative overflow-hidden min-h-[220px] flex flex-col justify-between'; 
                card.innerHTML = content; 
                grid.appendChild(card); 
            }
        }

        window.revealFate = function(index) {
            if(fateBucket.length === 0 || isSpinning[index]) return;
            isSpinning[index] = true;
            const btn = document.querySelector(`#action-area-${index} button`);
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.className = "w-full py-4 bg-orange-500 text-white font-bold rounded-xl shadow-lg cursor-wait";

            setTimeout(() => {
                const fate = fateBucket.pop();
                const card = document.getElementById(`card-${index}`);
                const area = document.getElementById(`action-area-${index}`);
                let resHTML, cls;
                
                if(fate === 'Oven') {
                    cls = 'card-oven';
                    resHTML = `<div class="text-center animate-pop relative z-20"><div class="text-4xl mb-2">üî•</div><h3 class="font-header text-3xl">OVEN</h3><button onclick="window.resetCard(${index}, '${fate}')" class="mt-2 text-xs font-bold underline opacity-70 hover:opacity-100">Re-roll</button></div>`;
                    speak(groupsData[index].name + ", Oven!");
                } else {
                    cls = 'card-hob';
                    resHTML = `<div class="text-center animate-pop relative z-20"><div class="text-4xl mb-2">‚ö°</div><h3 class="font-header text-3xl">INDUCTION</h3><button onclick="window.resetCard(${index}, '${fate}')" class="mt-2 text-xs font-bold underline opacity-70 hover:opacity-100">Re-roll</button></div>`;
                    speak(groupsData[index].name + ", Induction!");
                }
                card.className = `rounded-3xl p-6 shadow-lg relative overflow-hidden min-h-[220px] flex flex-col justify-between ${cls}`;
                if(groupsData[index].color) card.style.backgroundColor = ""; // Clear custom color on reveal to show gradient
                area.innerHTML = resHTML;
                isSpinning[index] = false;
                logAction(`${groupsData[index].name} got ${fate}`);
                window.safeConfetti({ particleCount: 50, origin: { x: (card.getBoundingClientRect().left + card.offsetWidth/2)/window.innerWidth, y: (card.getBoundingClientRect().top + card.offsetHeight/2)/window.innerHeight }});
            }, 1500);
        }

        window.resetCard = function(index, fate) {
            fateBucket.push(fate);
            fateBucket.sort(() => Math.random() - 0.5);
            renderCard(index, groupsData[index]);
            logAction(`Reset fate for ${groupsData[index].name}`);
        }

        // --- SCOREBOARD ---
        window.renderScoreboard = function() {
            const list = document.getElementById('scoreboard-list');
            list.innerHTML = '';
            groupsData.forEach((group, index) => {
                const bg = group.scored ? 'bg-green-50 border-green-200' : 'bg-white border-slate-100';
                const row = document.createElement('div');
                row.className = `flex items-center justify-between border p-3 rounded-xl ${bg} dark:bg-gray-800 dark:border-gray-700`;
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-slate-200 dark:bg-slate-600 flex items-center justify-center font-bold text-sm">${index + 1}</div>
                        <div><h3 class="font-bold text-sm dark:text-white">${group.name}</h3><p class="text-sm text-slate-400">${group.members.join(', ')}</p></div>
                    </div>
                    <button onclick="window.openJudgeModal(${index})" class="px-3 py-1 bg-slate-800 text-white text-xs rounded-lg font-bold shadow hover:bg-slate-700">${group.scored ? 'Edit Score' : 'Judge'}</button>
                `;
                list.appendChild(row);
            });
        }

        window.openJudgeModal = (idx) => {
            currentJudgingIndex = idx;
            document.getElementById('judge-team-name').innerText = groupsData[idx].name;
            const s = groupsData[idx].scores;
            document.getElementById('score-j1').value = s[0] || '';
            document.getElementById('score-j2').value = s[1] || '';
            document.getElementById('score-j3').value = s[2] || '';
            document.getElementById('score-j4').value = s[3] || '';
            document.getElementById('judge-modal').classList.remove('hidden');
        }
        window.closeJudgeModal = () => document.getElementById('judge-modal').classList.add('hidden');
        
        window.saveScore = () => {
            const s1 = parseInt(document.getElementById('score-j1').value)||0, s2 = parseInt(document.getElementById('score-j2').value)||0, s3 = parseInt(document.getElementById('score-j3').value)||0, s4 = parseInt(document.getElementById('score-j4').value)||0;
            groupsData[currentJudgingIndex].scores = [s1,s2,s3,s4];
            groupsData[currentJudgingIndex].total = s1+s2+s3+s4;
            groupsData[currentJudgingIndex].scored = true;
            renderScoreboard();
            closeJudgeModal();
            logAction(`Scored ${groupsData[currentJudgingIndex].name}: ${s1+s2+s3+s4}`);
        }

        // --- RESULTS REVEAL (Updated Logic) ---
        window.revealResults = () => {
            document.getElementById('results-modal').classList.remove('hidden');
            const list = document.getElementById('results-list');
            list.innerHTML = '';
            
            let max = -1, min = 9999;
            groupsData.forEach(g => { if(g.total > max) max = g.total; if(g.total < min) min = g.total; });
            
            groupsData.forEach((g, i) => {
                const el = document.createElement('div');
                let badge = '';
                let extraInfo = '';
                let nameSize = 'text-lg'; // Default
                let cardPadding = 'p-4'; // Default

                if(g.total === max && max > 0) {
                    badge = 'üèÜ WINNER';
                    // UPDATED IMAGE SOURCE & ERROR HANDLING
                    extraInfo = `
                        <div class="mt-2 text-center animate-bounce-slow">
                            <img src="https://images.unsplash.com/photo-1579656381226-5fc7035548c7?q=80&w=200&auto=format&fit=crop" 
                                 onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
                                 alt="Pillow Prize" 
                                 class="w-24 h-24 object-cover rounded-lg mx-auto shadow-md border-2 border-orange-200 bg-white">
                            <div class="hidden text-6xl my-2">üõå</div>
                            <div class="text-sm text-orange-600 font-bold mt-1">üéÅ Prize: 1 Pillow / Person</div>
                        </div>
                    `;
                    nameSize = 'text-4xl text-orange-600'; // Much bigger name
                    cardPadding = 'p-8'; // Bigger card
                }
                else if(g.total === min && min < max) badge = 'üßΩ DISHWASHER';
                
                el.className = `bg-white rounded-xl ${cardPadding} shadow flex justify-between items-center opacity-0 translate-y-4 transition-all duration-500`;
                el.innerHTML = `<div><h3 class="font-bold ${nameSize}">${g.name}</h3><p class="text-base text-slate-500">${g.members.join(', ')}</p><span class="text-xs font-bold text-purple-600">${badge}</span>${extraInfo}</div><div class="text-3xl font-bold">${g.total}</div>`;
                list.appendChild(el);
                
                setTimeout(() => {
                    el.classList.remove('opacity-0', 'translate-y-4');
                    if(badge.includes('WINNER')) { 
                        // Massive scale up for winner
                        el.classList.add('ring-8', 'ring-yellow-400', 'bg-yellow-50', 'scale-110', 'z-10', 'my-4', 'shadow-2xl'); 
                        speak("Winner is " + g.name + ". You win pillows!"); 
                        window.safeConfetti({ particleCount: 100, origin: { y: 0.6 }}); 
                    }
                }, i * 600);
            });
        }

        window.shareResults = () => {
            let text = "üèÜ UC Home MasterChef Results üèÜ\n\n";
            groupsData.forEach(g => text += `${g.name}: ${g.total} pts\n`);
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            alert("Copied!");
        }

        window.closeResultsModal = () => document.getElementById('results-modal').classList.add('hidden');
        window.showResetModal = () => document.getElementById('reset-modal').classList.remove('hidden');
        window.hideResetModal = () => document.getElementById('reset-modal').classList.add('hidden');
        window.confirmResetGame = () => {
            isSpinning = {};
            groupsData.forEach(g => { g.scores = [0,0,0,0]; g.total = 0; g.scored = false; g.cheer = ''; g.color = ''; });
            initGame();
            logAction("Game Reset");
            window.hideResetModal();
        }
        window.safeConfetti = (opts) => { if(typeof confetti === 'function') confetti(opts); }
    </script>
</body>
</html>